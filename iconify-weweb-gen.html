<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iconify Generator</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .selected {
      border: solid 1px lightseagreen;
      border-radius: 10px;
      color: seagreen;
    }
    #iconsContainer {
        overflow: auto;
        max-height: 100vh;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container my-5">
    <h1 class="text-center">Iconify Generator</h1>

    <!-- Iconset Dropdown -->
    <div class="mb-3">
      <label for="iconsetDropdown" class="form-label">Choose Iconset:</label>
      <select id="iconsetDropdown" class="form-select"></select>
    </div>

    <!-- Icons Display -->
    <div id="iconsContainer" class="d-flex flex-wrap justify-content-center"></div>

    <!-- Generate Buttons -->
    <div class="mt-3">
        <button id="generateForAll" class="btn btn-primary">Generate for All</button>
        <button id="generateForSelected" class="btn btn-success">Generate for Selected</button>
    </div>

    <!-- CSS and JSON Textareas -->
    <div class="mt-5">
      <label for="cssTextarea" class="form-label">Generated CSS:</label>
      <textarea id="cssTextarea" class="form-control" rows="10" readonly></textarea>
      <button id="downloadCss" class="btn btn-primary mt-2">Download CSS</button>
    </div>

    <div class="mt-4">
      <label for="jsonTextarea" class="form-label">Generated JSON:</label>
      <textarea id="jsonTextarea" class="form-control" rows="10" readonly></textarea>
      <button id="downloadJson" class="btn btn-success mt-2">Download JSON</button>
    </div>
  </div>

  <!-- jQuery and Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.iconify.design/1/1.0.7/iconify.min.js"></script>

  <script>
    $(document).ready(function() {
// Function to fetch icon collections
function fetchIconCollections() {
  $.ajax({
    url: 'https://api.iconify.design/collections',
    method: 'GET',
    success: function(data) {
      // Sort iconsets alphabetically
      const sortedIconsets = Object.entries(data)
        .sort((a, b) => a[1].name.localeCompare(b[1].name));

      // Populate dropdown with sorted iconsets and license info
      const iconsetDropdown = $('#iconsetDropdown');
      iconsetDropdown.empty();

      sortedIconsets.forEach(([key, value]) => {
        const licenseInfo = value.license ? ` (${value.license.title})` : '';
        iconsetDropdown.append($('<option>').text(`${value.name}${licenseInfo}`).attr('value', key));
      });

      // Fetch icons for the first iconset by default
      const defaultIconset = sortedIconsets[0][0];
      fetchIcons(defaultIconset);
    },
    error: function(error) {
      console.error('Error fetching iconsets:', error);
    }
  });
}


      // Function to fetch icons for a selected iconset
      function fetchIcons(iconSetName) {
        $.ajax({
          url: `https://api.iconify.design/collection?prefix=${iconSetName}`,
          method: 'GET',
          success: function(data) {
            // Display icons in container
            const iconsContainer = $('#iconsContainer');
            iconsContainer.empty();
            $.each(data.uncategorized, function(_, iconName) {
              const iconDiv = $(`<div class="m-2 p-2 text-center" style="cursor: pointer;"><i class="iconify" data-icon="${iconSetName}:${iconName}" style="font-size: 2rem;"></i><div>${iconName}</div></div>`);
              iconsContainer.append(iconDiv);

              // Toggle selection on click
              iconDiv.click(function() {
                iconDiv.toggleClass('selected');
                const selectedIcons = $('.selected').map(function() {
                    return $(this).find('svg').data('icon').split(':')[1];
                }).get();
                $('#generateForSelected').text('Generate for Selected' +  (selectedIcons.length>0?' (' + selectedIcons.length + ')':''));
              });
            });
          },
          error: function(error) {
            console.error('Error fetching icons:', error);
          }
        });
      }

        // Function to get icon list from collection endpoint
        async function getIconList(iconSetName) {
        try {
            const collectionUrl = `https://api.iconify.design/collection?prefix=${iconSetName}`;
            const response = await fetch(collectionUrl);
            const iconSetDetails = await response.json(); // Parse JSON here

            // Check if "uncategorized" property exists
            if (iconSetDetails.uncategorized) {
            return iconSetDetails.uncategorized;
            } else {
            throw new Error(`Icon list not found for ${iconSetName}`);
            }
        } catch (error) {
            throw new Error(`Error getting icon list: ${error.message}`);
        }
        }

      // Function to generate CSS and JSON
// Function to generate CSS and JSON
async function generateCssAndJson(icList) {
  try {
    const iconSetName = $('#iconsetDropdown').val();
    // Fetch the icon list from the collection endpoint 
    const iconList = (icList.length==0?await getIconList(iconSetName):icList);

    // Fetch the icon set CSS from the API 
    const cssUrl = `https://api.iconify.design/${iconSetName}.css?icons=${iconList.join(',')}`;
    console.log(cssUrl);
    const response = await fetch(cssUrl);
    const iconSetCss = await response.text(); // Use text() for CSS

    // Modify the CSS
    const modifiedCss = modifyCssTemplate(iconSetName, iconSetCss, iconList);

    // Generate JSON
    const jsonContent = JSON.stringify(iconList.map(name => ({ name, class: `iconify-${iconSetName}--${name}` })), null, 2);

    // Display generated content
    $('#cssTextarea').val(modifiedCss);
    $('#jsonTextarea').val(jsonContent);
  } catch (error) {
    console.error(error.message);
  }
}

// Function to modify CSS template
function modifyCssTemplate(iconSetName, iconSetCss, iconList) {
  // Replace class names and append your required template
  const modifiedCss = iconSetCss
    .replace(new RegExp(`--svg: url\\("data:image`, 'g'), 'background-image: url("data:image')
    .replace(new RegExp(`\\.icon--${iconSetName}`, 'g'), `.iconify-${iconSetName}`)
    .replace(new RegExp(`\\.icon--${iconSetName}--[A-Za-z0-9_-]+`, 'g'), match => {
      const iconName = match.split('--')[1];
      return `.iconify-${iconSetName}--${iconName}`;
    });

  // Append your required template before the modified icon block
  const templateToPrepend = `
    .iconify-${iconSetName},
    .icon [class^="iconify-${iconSetName}-"],
    .icon [class*=" iconify-${iconSetName}-"],
    .ww-icon [class^="iconify-${iconSetName}-"] {
      display: inline-block;
      width: 100%;
      height: 100%;
      background-position-x: center;
      background-position-y: center;
      background-size: 100%;
      background-repeat: no-repeat;
      aspect-ratio: 1;
    }
  `.trim();

  return modifiedCss.replace(`.iconify-${iconSetName} {`, `${templateToPrepend}\n\n.iconify-${iconSetName} {`);
}

      // Function to download content
      function downloadContent(content, fileName, fileType) {
        const blob = new Blob([content], { type: `text/${fileType}` });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // Event handler for iconset dropdown change
      $('#iconsetDropdown').change(function() {
        const selectedIconset = $(this).val();
        if (selectedIconset) {
          fetchIcons(selectedIconset);
        }
      });

      // Event handler for "Generate for Selected" button
      $('#generateForSelected').click(function() {
        const selectedIcons = $('.selected').map(function() {
          return $(this).find('svg').data('icon').split(':')[1];
        }).get();
        generateCssAndJson(selectedIcons);
      });

      // Event handler for "Generate for All" button
      $('#generateForAll').click(function() {
        const allIcons = $('#iconsContainer i').map(function() {
          return $(this).data('icon');
        }).get();
        generateCssAndJson(allIcons);
      });

      // Event handler for "Download CSS" button
      $('#downloadCss').click(function() {
        const cssContent = $('#cssTextarea').val();
        downloadContent(cssContent, 'weweb-iconify-' + $('#iconsetDropdown').val() +'.css', 'css');
      });

      // Event handler for "Download JSON" button
      $('#downloadJson').click(function() {
        const jsonContent = $('#jsonTextarea').val();
        downloadContent(jsonContent, 'weweb-iconify-' + $('#iconsetDropdown').val() +'.json', 'json');
      });

      // Initial fetch of icon collections
      fetchIconCollections();
    });
  </script>
</body>
</html>
